{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://odin-ai.dev/schemas/backup.schema.json",
  "title": "ODIN Backup Schema",
  "description": "Schema for ODIN v6.0 backup files (.bak.json) containing pre-change checkpoints, git diffs, and working tree snapshots",
  "type": "object",
  "required": [
    "odin_version",
    "backup_timestamp",
    "reason",
    "project_root",
    "git_available",
    "pre_change_checkpoint",
    "project_integrity_hash",
    "git_info",
    "working_tree_snapshot",
    "metadata"
  ],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this JSON schema"
    },
    "odin_version": {
      "type": "string",
      "description": "ODIN version that created this backup",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "backup_timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp of backup creation",
      "format": "date-time"
    },
    "reason": {
      "type": "string",
      "description": "Reason for creating this backup",
      "examples": [
        "pre_write_operation",
        "manual_backup",
        "pre_rollback_to_*",
        "before_dependency_update"
      ]
    },
    "project_root": {
      "type": "string",
      "description": "Absolute path to the project root directory"
    },
    "git_available": {
      "type": "boolean",
      "description": "Whether git repository was available during backup"
    },
    "pre_change_checkpoint": {
      "type": "object",
      "description": "Complete AI_CHECKPOINT.json state before changes",
      "properties": {
        "version": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" },
        "current_state": { "type": "string" },
        "last_action": { "type": "string" },
        "integrity": {
          "type": "object",
          "properties": {
            "binary_sha256": { "type": ["string", "null"] },
            "semantic_hash": { "type": ["string", "null"] }
          }
        },
        "context": {
          "type": "object",
          "properties": {
            "language": { "type": ["string", "null"] },
            "framework": { "type": ["string", "null"] },
            "architecture": { "type": ["string", "null"] }
          }
        },
        "backup_ref": { "type": ["string", "null"] },
        "test_coverage": { "type": "number" }
      }
    },
    "project_integrity_hash": {
      "type": "string",
      "description": "SHA-256 hash of all important project files",
      "pattern": "^[a-f0-9]{64}$"
    },
    "git_info": {
      "type": "object",
      "description": "Git repository information and diff patch",
      "required": ["has_changes", "diff_patch", "commit_hash"],
      "properties": {
        "has_changes": {
          "type": "boolean",
          "description": "Whether there were uncommitted changes"
        },
        "diff_patch": {
          "type": ["string", "null"],
          "description": "Git diff patch content (unified format)"
        },
        "commit_hash": {
          "type": ["string", "null"],
          "description": "Current git commit hash (SHA-1)",
          "pattern": "^[a-f0-9]{40}$"
        }
      }
    },
    "working_tree_snapshot": {
      "type": "object",
      "description": "Compressed working tree snapshot",
      "required": ["available", "compressed_data", "compression"],
      "properties": {
        "available": {
          "type": "boolean",
          "description": "Whether working tree snapshot was created"
        },
        "compressed_data": {
          "type": ["string", "null"],
          "description": "Base64 encoded compressed tar.gz archive of working tree"
        },
        "compression": {
          "type": ["string", "null"],
          "enum": ["gzip+base64", null],
          "description": "Compression method used"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional backup metadata",
      "required": ["files_count", "backup_size_estimate", "creation_host", "odin_session_id"],
      "properties": {
        "files_count": {
          "type": "integer",
          "description": "Number of files in project at backup time",
          "minimum": 0
        },
        "backup_size_estimate": {
          "type": "integer",
          "description": "Estimated backup size in KB",
          "minimum": 0
        },
        "creation_host": {
          "type": "string",
          "description": "Hostname/computer where backup was created"
        },
        "odin_session_id": {
          "type": "string",
          "description": "ODIN session identifier from checkpoint"
        }
      }
    }
  }
}
